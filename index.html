<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kink Compatibility</title>

  <!-- Load the Playpen Sans Hebrew font -->
  <link href="https://fonts.googleapis.com/css2?family=Playpen+Sans+Hebrew&display=swap" rel="stylesheet">

  <style>
    body {
      background-color: black;
      color: white;
      font-family: 'Playpen Sans Hebrew', cursive;
      font-size: 16px;
      font-weight: 400;
      font-style: normal;
    }

    button {
      background-color: #222;
      color: white;
      border: 1px solid #444;
      padding: 8px 12px;
      margin: 4px;
      cursor: pointer;
      font-family: 'Playpen Sans Hebrew', cursive;
    }

    button:hover {
      background-color: #444;
    }

    input[type="file"], select {
      background-color: #111;
      color: white;
      border: 1px solid #555;
      font-family: 'Playpen Sans Hebrew', cursive;
    }

    h1, h3 {
      color: white;
      font-family: 'Playpen Sans Hebrew', cursive;
    }

    div {
      margin-bottom: 10px;
    }

    #progressContainer {
      width: 100%;
      background-color: #222;
      border: 1px solid #444;
      margin-bottom: 10px;
    }

    #progressBar {
      height: 20px;
      background-color: #4caf50;
      transition: width 1s ease-in-out;
    }
  </style>
</head>
<body>
  <h1>Kink Compatibility Survey</h1>

  <div>
    <button id="givingBtn">Giving</button>
    <button id="receivingBtn">Receiving</button>
    <button id="neutralBtn">Neutral</button>
    <button id="downloadBtn">Download Updated Template</button>
    <button id="newSurveyBtn">Start New Survey</button>
  </div>

  <div id="categoryContainer"></div>
  <div id="kinkList"></div>

  <h3>Upload Your Survey</h3>
  <input type="file" id="fileA" />

  <h3>Upload Partner's Survey</h3>
  <input type="file" id="fileB" />

  <button id="compareBtn">Compare Compatibility</button>

  <div id="progressContainer" style="display: none;">
    <div id="progressBar"></div>
  </div>

  <div id="comparisonResult"></div>

  <script>
    const categoryContainer = document.getElementById('categoryContainer');
    const kinkList = document.getElementById('kinkList');

    let surveyA = null;
    let surveyB = null;
    let currentAction = 'Giving';
    let currentCategory = null;

    document.getElementById('fileA').addEventListener('change', (e) => {
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          surveyA = JSON.parse(ev.target.result);
          showCategories();
        } catch {
          alert('Invalid JSON file for Survey A.');
        }
      };
      reader.readAsText(e.target.files[0]);
    });

    document.getElementById('newSurveyBtn').addEventListener('click', () => {
      //update template version
      fetch('template-survey.json?v=7')
        .then(response => {
          if (!response.ok) throw new Error('Failed to load template file.');
          return response.json();
        })
        .then(data => {
          surveyA = data;
          showCategories();
        })
        .catch(err => alert('Error loading template: ' + err.message));
    });

    document.getElementById('fileB').addEventListener('change', (e) => {
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          surveyB = JSON.parse(ev.target.result);
        } catch {
          alert('Invalid JSON file for Survey B.');
        }
      };
      reader.readAsText(e.target.files[0]);
    });

    function showCategories() {
      categoryContainer.innerHTML = '';
      if (!surveyA) return;

      const categories = Object.keys(surveyA);
      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.textContent = cat;
        btn.onclick = () => showKinks(cat);
        categoryContainer.appendChild(btn);
      });
    }

    function showKinks(category) {
      currentCategory = category;
      kinkList.innerHTML = '';
      if (!surveyA) return;

      const kinks = surveyA[category][currentAction];
      if (!kinks || kinks.length === 0) {
        kinkList.textContent = 'No items here.';
        return;
      }

      kinks.forEach((kink) => {
        const container = document.createElement('div');
        container.style.marginBottom = '10px';

        const label = document.createElement('span');
        label.textContent = kink.name + ': ';
        container.appendChild(label);

        const select = document.createElement('select');

        const emptyOption = document.createElement('option');
        emptyOption.value = '';
        emptyOption.textContent = '‚Äî';
        select.appendChild(emptyOption);

        for (let i = 1; i <= 6; i++) {
          const option = document.createElement('option');
          option.value = i;
          option.textContent = i;
          if (kink.rating == i) option.selected = true;
          select.appendChild(option);
        }

        select.addEventListener('change', () => {
          kink.rating = select.value === '' ? null : Number(select.value);
        });

        container.appendChild(select);
        kinkList.appendChild(container);
      });
    }

    document.getElementById('givingBtn').onclick = () => {
      currentAction = 'Giving';
      showCategories();
      if (currentCategory) showKinks(currentCategory);
    };

    document.getElementById('receivingBtn').onclick = () => {
      currentAction = 'Receiving';
      showCategories();
      if (currentCategory) showKinks(currentCategory);
    };

    document.getElementById('neutralBtn').onclick = () => {
      currentAction = 'Neutral';
      showCategories();
      if (currentCategory) showKinks(currentCategory);
    };

    document.getElementById('downloadBtn').onclick = () => {
      if (!surveyA) {
        alert('No survey loaded.');
        return;
      }

      const blob = new Blob(
        [JSON.stringify(surveyA, null, 2)],
        { type: 'application/json' }
      );

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kink-survey.json';
      a.click();
      URL.revokeObjectURL(url);
    };

    document.getElementById('compareBtn').onclick = () => {
      const resultDiv = document.getElementById('comparisonResult');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');

      resultDiv.innerHTML = '';
      progressContainer.style.display = 'block';
      progressBar.style.width = '0%';

      if (!surveyA || !surveyB) {
        resultDiv.textContent = 'Please upload both surveys to compare.';
        progressContainer.style.display = 'none';
        return;
      }

      const categories = Object.keys(surveyA);
      let totalScore = 0;
      let count = 0;
      let redFlags = [];
      let yellowFlags = [];

      categories.forEach(category => {
        if (!surveyB[category]) return;

        ['Giving', 'Receiving', 'Neutral'].forEach(action => {
          const listA = surveyA[category][action] || [];
          const listB = surveyB[category][
            action === 'Giving' ? 'Receiving' :
            action === 'Receiving' ? 'Giving' : 'Neutral'
          ] || [];

          listA.forEach(itemA => {
            const match = listB.find(itemB => itemB.name === itemA.name);
            if (match) {
              const ratingA = Number(itemA.rating);
              const ratingB = Number(match.rating);

              if (!isNaN(ratingA) && !isNaN(ratingB)) {
                const diff = Math.abs(ratingA - ratingB);
                const score = 100 - diff * 20;
                totalScore += score;
                count++;

                if ((ratingA === 6 && ratingB === 1) || (ratingA === 1 && ratingB === 6)) {
                  redFlags.push(itemA.name);
                } else if (
                  (ratingA === 6 && ratingB === 2) || (ratingA === 2 && ratingB === 6) ||
                  (ratingA === 5 && ratingB === 1) || (ratingA === 1 && ratingB === 5)
                ) {
                  yellowFlags.push(itemA.name);
                }
              }
            }
          });
        });
      });

      if (count === 0) {
        resultDiv.textContent = 'No shared rated items to compare.';
        progressContainer.style.display = 'none';
        return;
      }

      const avgScore = Math.round(totalScore / count);
      progressBar.style.width = `${avgScore}%`;

      let output = `<h3>Compatibility Score: ${avgScore}%</h3>`;
      if (redFlags.length) {
        output += `<p>üö© Red flags: ${[...new Set(redFlags)].join(', ')}</p>`;
      }
      if (yellowFlags.length) {
        output += `<p>‚ö†Ô∏è Yellow flags: ${[...new Set(yellowFlags)].join(', ')}</p>`;
      }

      resultDiv.innerHTML = output;
    };
  </script>
</body>
</html>
